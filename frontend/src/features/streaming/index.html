<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test</title>
</head>
<body>
    <h1>테스트</h1>
    <p>데이터: <span id="Data">N/A</span></p>
    <button id="start">테스트 시작</button>
    <button id="stop">테스트 중단</button>

    <script>
        const DataElement = document.getElementById("Data");
        const startButton = document.getElementById("start");
        const stopButton = document.getElementById("stop");

        let socket;
        let streaming = false;

        // WebSocket 연결 생성 함수
        function connectWebSocket() {
            socket = new WebSocket("ws://70.12.246.80:8080/api/v1/ws"); // 백엔드 WebSocket URL

            // WebSocket 연결 성공 시
            socket.onopen = async () => {
                console.log("WebSocket 연결 성공");
                streaming = true;

                // // // JSON 데이터 준비
                // const dataToSend = { name: ["hammer", "drill"] };

                try {
                    // HTTP POST 요청 보내기
                    const response = await fetch("http://70.12.246.80:8080/api/v1/embedded/detect-helmet/start", { // 지정된 URL로 변경
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        // body: JSON.stringify(dataToSend), // 데이터를 JSON 문자열로 변환하여 전송
                    });

                    // 응답 상태 확인
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    // 응답 본문이 비어 있는지 확인 후 처리
                    const contentLength = response.headers.get("Content-Length");
                    if (contentLength === "0" || response.status === 204) {
                        console.warn("서버 응답이 비어 있습니다.");
                        return;
                    }

                    // JSON 파싱 시도
                    const responseData = await response.json();
                    console.log("POST 요청 성공, 서버 응답:", responseData);
                } catch (error) {
                    console.error("POST 요청 중 오류 발생:", error);
                }
            };


            // WebSocket 메시지 수신 시 (문자열 데이터 수신)
            socket.onmessage = (event) => {
                try {
                    if (typeof event.data === "string") {
                        console.log("데이터 수신:", event.data);

                        // 수신된 데이터를 화면에 표시
                        DataElement.textContent = event.data;
                        if (DataElement.textContent == "ok"){
                            socket.close();
                        }
                    } else {
                        console.warn("알 수 없는 데이터 형식:", event.data);
                    }
                } catch (error) {
                    console.error("데이터 처리 중 오류:", error);
                }
            };

            // WebSocket 연결 종료 시
            socket.onclose = () => {
                console.log("WebSocket 연결 종료");
                streaming = false;
            };

            // WebSocket 오류 발생 시
            socket.onerror = (error) => {
                console.error("WebSocket 오류:", error);
            };
        }

        // 테스트 시작 버튼 클릭 시
        startButton.addEventListener("click", () => {
            if (!streaming) {
                connectWebSocket();
                console.log("테스트 시작");
            } else {
                console.log("이미 테스트 중입니다.");
            }
        });

        // 테스트 중단 버튼 클릭 시
        stopButton.addEventListener("click", () => {
            if (socket && streaming) {
                socket.close(); // WebSocket 연결 종료
                console.log("테스트 중단");
            }
        });
    </script>
</body>
</html>
